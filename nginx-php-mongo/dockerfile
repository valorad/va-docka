FROM php:fpm-alpine

# php mongo extension 
# --> dependencies
RUN apk update \
&& apk add --no-cache \
      autoconf \
      gcc \
      libc-dev \
      make \
      linux-headers \
&& pecl install mongodb \
&& echo "extension=mongodb.so" > /usr/local/etc/php/conf.d/ext.ini \
# --> clearings
&& apk del \
      autoconf \
      gcc \
      libc-dev \
      make \
      linux-headers \
&& rm -rf /var/cache/apk/*

# apk installation
RUN apk update \
 && apk add --no-cache \
      openssl-dev \
      zlib-dev \
      nginx \
      sudo \
 && rm -rf /var/cache/apk/* \
 # --> delete default nginx conf
 && rm /etc/nginx/conf.d/*

# composer installation
RUN php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');" \
 && php composer-setup.php --install-dir=/usr/bin --filename=composer \
 && php -r "unlink('composer-setup.php');"

ADD ./index.sh /workspace/
ADD ./index.php /workspace/www/default/
ADD ./conf.d/default.conf /etc/nginx/conf.d/

VOLUME ["/workspace/www", "/workspace/docking"]

WORKDIR /workspace

EXPOSE 443 80

ENTRYPOINT ["nginx -g 'pid /tmp/nginx.pid; daemon off;'"]